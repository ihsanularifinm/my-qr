<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>QR Code Generator - MikroTik Voucher</title>
	<!-- Favicon -->
	<link rel="icon" type="image/svg+xml" href="../assets/qr-code.svg">
	<!-- Local Assets: No CDN -->
    <link rel="stylesheet" href="../css/style.css">
	<script src="../js/qrcode.min.js"></script>
	<style>
		@media print {
            /* Fix print styles if local css interferes */
            body { background: white !important; }
            .no-print { display: none !important; }
            #qr-container { display: grid !important; }
        }
		@media print {
			.no-print { display: none !important; }
			.print-only { display: block !important; }
			body { background: white !important; }
			.voucher-card { page-break-inside: avoid; break-inside: avoid; }
			/* QR Only print: compact grid */
			.qr-only-mode { grid-template-columns: repeat(auto-fill, minmax(100px, max-content)) !important; gap: 8px !important; }
			.qr-only-mode .voucher-card { width: fit-content !important; padding: 4px !important; }
		}
		.print-only { display: none; }
		.qr-wrapper {
			position: relative;
			display: inline-block;
		}
		.qr-logo {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			padding: 2px;
			border-radius: 4px;
		}
		.qr-wrapper {
			/* Force 1:1 Aspect Ratio Overriding Inline Styles */
			height: auto !important;
			aspect-ratio: 1/1 !important;
		}
		/* Toast Notification */
		#toast-notification {
			visibility: hidden;
			min-width: 250px;
			background-color: #333;
			color: #fff;
			text-align: center;
			border-radius: 8px;
			padding: 16px;
			position: fixed;
			z-index: 9999; /* High Z-Index to stay on top */
			left: 50%;
			bottom: 30px;
			transform: translateX(-50%);
			font-size: 14px;
			opacity: 0;
			transition: opacity 0.5s, bottom 0.5s;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		#toast-notification.show {
			visibility: visible;
			opacity: 1;
			bottom: 50px;
		}
		/* QR Only mode */
		.qr-only-mode .voucher-credentials { display: none; }
		.qr-only-mode .separator-line { display: none; } /* Added: Hide separator in main view */
		.qr-only-mode .card-body { line-height: 0 !important; } /* Tight fit, no baseline gap */
		.qr-only-mode .qr-wrapper { margin-bottom: 0; }
		.qr-only-mode #qr-container { justify-items: center; }
	</style>
</head>
<body class="bg-gray-100 min-h-screen">
	<!-- Header -->
	<header class="bg-blue-600 text-white py-4 px-6 no-print sticky top-0 z-50 shadow-md">
		<h1 class="text-2xl font-bold">üé´ QR Code Generator</h1>
		<p class="text-blue-100">Generate QR codes for MikroTik Hotspot vouchers</p>
	</header>

	<main class="max-w-6xl mx-auto p-6">
		<!-- Logo Settings -->
		<section class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
			<h2 class="text-xl font-bold mb-4 text-gray-800">üñºÔ∏è Logo Settings (Optional)</h2>
			<div class="flex items-end gap-4">
				<div class="flex-1">
					<label class="block text-sm font-medium text-gray-700 mb-1">Upload Logo</label>
					<input type="file" id="logo-input" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-[42px]">
				</div>
				<div id="logo-preview" class="w-[42px] h-[42px] border border-gray-300 rounded-md flex items-center justify-center bg-gray-50 shrink-0">
					<span class="text-gray-400 text-[10px] text-center leading-tight">No<br>logo</span>
				</div>
				<button onclick="clearLogo()" class="h-[42px] w-[42px] flex items-center justify-center text-red-500 hover:text-white border border-red-500 hover:bg-red-500 rounded-md transition-colors shrink-0" title="Clear Logo">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
					</svg>
				</button>
			</div>
		</section>

		<!-- Input Section -->
		<!-- Input Section -->
		<section class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
			<h2 class="text-xl font-bold mb-4 text-gray-800">üìù Input User Password</h2>
			
			<!-- Tabs -->
			<div class="flex border-b mb-6">
				<button id="tab-single" onclick="switchTab('single')" class="px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">Single</button>
				<button id="tab-bulk" onclick="switchTab('bulk')" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Bulk</button>
			</div>

			<!-- Single Input -->
			<div id="input-single" class="space-y-4">
				<!-- Single Mode Toggle -->
				<div class="flex gap-6 mb-2">
					<label class="flex items-center cursor-pointer">
						<input type="radio" name="single-mode" value="normal" checked onchange="toggleSingleMode()" class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
						<span class="ml-2 text-sm text-gray-700 font-medium">User & Password</span>
					</label>
					<label class="flex items-center cursor-pointer">
						<input type="radio" name="single-mode" value="same" onchange="toggleSingleMode()" class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
						<span class="ml-2 text-sm text-gray-700 font-medium">User = Password</span>
					</label>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
						<input type="text" id="single-username" placeholder="user123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
					</div>
					<div id="single-password-wrapper">
						<label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
						<input type="text" id="single-password" placeholder="pass456" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
					</div>
				</div>
				<button onclick="generateSingle()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md">
					Generate QR
				</button>
			</div>

			<!-- Bulk Input -->
			<div id="input-bulk" class="hidden space-y-4">
				<!-- Bulk Mode Toggle -->
				<div class="flex gap-6 mb-2">
					<label class="flex items-center cursor-pointer">
						<input type="radio" name="bulk-mode" value="normal" checked onchange="toggleBulkMode()" class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
						<span class="ml-2 text-sm text-gray-700 font-medium">User & Password</span>
					</label>
					<label class="flex items-center cursor-pointer">
						<input type="radio" name="bulk-mode" value="same" onchange="toggleBulkMode()" class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
						<span class="ml-2 text-sm text-gray-700 font-medium">User = Password</span>
					</label>
				</div>

				<div>
					<label class="block text-sm font-medium text-gray-700 mb-1" id="bulk-hint">
						Format: username:password (one per line)
					</label>
					<textarea id="bulk-input" rows="8" placeholder="user1:pass1
user2:pass2
user3:pass3" class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
				</div>
				<button onclick="generateBulk()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md">
					Generate All QR Codes
				</button>
			</div>
		</section>

		<!-- Actions -->
		<section class="bg-white rounded-lg shadow-md p-4 mb-6 no-print" id="actions-section" style="display: none;">
			<div class="flex flex-wrap items-center gap-4">
				<!-- Print Mode Toggle -->
				<div class="flex items-center gap-2">
					<span class="text-sm font-medium text-gray-700">Print Mode:</span>
					<label class="flex items-center gap-1 cursor-pointer">
						<input type="radio" name="print-mode" value="qr-only" class="accent-blue-600" onchange="togglePrintMode('qr-only')">
						<span class="text-sm">QR Only</span>
					</label>
					<label class="flex items-center gap-1 cursor-pointer">
						<input type="radio" name="print-mode" value="full" class="accent-blue-600" checked onchange="togglePrintMode('full')">
						<span class="text-sm">QR + Credentials</span>
					</label>
				</div>

				<!-- Display Size -->
				<div class="flex items-center gap-2">
					<span class="text-sm font-medium text-gray-700">Display:</span>
					<select id="display-size" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateDisplaySize()">
						<option value="100">Small</option>
						<option value="150" selected>Medium</option>
						<option value="200">Large</option>
					</select>
				</div>

				<!-- Logo Size -->
				<div class="flex items-center gap-2">
					<span class="text-sm font-medium text-gray-700">Logo:</span>
					<select id="logo-size" class="px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateDisplaySize()">
						<option value="12">S</option>
						<option value="18" selected>M</option>
						<option value="25">L</option>
					</select>
				</div>

				<div class="flex-1"></div>

				<!-- Buttons -->
				<button onclick="openPreviewTab()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md flex items-center gap-2">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
					</svg>
					Preview & Print
				</button>
				<button onclick="clearAll()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-md">
					Clear All
				</button>
			</div>
		</section>


		<!-- QR Codes Grid -->
		<section id="qr-container" class="flex flex-wrap justify-center gap-4">
			<!-- QR codes will be generated here -->
		</section>
		<!-- QR Preview Modal (Single Card) -->
		<div id="qr-preview-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 no-print" onclick="closeQrPreviewModal(event)">
			<div class="bg-white rounded-xl shadow-2xl p-6 w-auto max-w-md mx-4 relative group" onclick="event.stopPropagation()">
				<!-- Close Button -->
				<button onclick="closeQrPreviewModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
				
				<!-- QR Preview Area -->
				<div class="flex flex-col items-center">
					<div id="modal-qr-preview" class="relative mb-4">
						<!-- QR + Logo will be rendered here dynamically -->
					</div>
					
					<!-- Credentials Info -->
					<div id="modal-credentials" class="text-center text-sm text-gray-600 mb-4">
						<!-- Credentials will be shown here -->
					</div>
				</div>
				
				<!-- Action Buttons (Always visible, more prominent on hover) -->
				<div class="flex flex-col gap-2 mt-2 border-t pt-4">
					<p class="text-xs text-gray-500 text-center mb-2">Open as single image:</p>
					<div class="flex gap-2">
						<button onclick="openMergedImage(false)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-3 rounded-md text-sm transition-colors border border-gray-300 flex items-center justify-center gap-1">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
							</svg>
							QR Only
						</button>
						<button id="btn-with-logo" onclick="openMergedImage(true)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-md text-sm transition-colors flex items-center justify-center gap-1">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
							</svg>
							QR + Logo
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Print Options Modal (Bulk Print) - Kept for bulk operations -->
		<div id="print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print">
			<div class="bg-white rounded-lg shadow-xl p-6 w-96 max-w-full mx-4">
				<h3 class="text-xl font-bold mb-4 text-gray-800">üñ®Ô∏è Print Options (All)</h3>
				<p class="text-gray-600 mb-6">You have a logo uploaded. How would you like to print all QR codes?</p>
				
				<div class="flex flex-col gap-3">
					<button onclick="processPrint(true)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
						</svg>
						With Logo
					</button>
					<button onclick="processPrint(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 border border-gray-300">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
						</svg>
						QR Only (No Logo)
					</button>
				</div>
				
				<div class="mt-4 pt-4 border-t flex justify-end">
					<button onclick="closePrintModal()" class="text-sm text-gray-500 hover:text-gray-700 underline">Cancel</button>
				</div>
			</div>
		</div>

	</main>

	<script>
		let voucherCount = 0;
		let logoDataUrl = null;
		let currentPrintTarget = 'all'; // 'all' or specific card ID
		let currentPreviewCardId = null; // For modal preview

		// Logo upload handling
		document.getElementById('logo-input').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(event) {
					logoDataUrl = event.target.result;
					document.getElementById('logo-preview').innerHTML = `<img src="${logoDataUrl}" class="w-full h-full object-contain rounded">`;
				};
				reader.readAsDataURL(file);
			}
		});

		function clearLogo() {
			logoDataUrl = null;
			document.getElementById('logo-input').value = '';
			document.getElementById('logo-preview').innerHTML = '<span class="text-gray-400 text-[10px] text-center leading-tight">No<br>logo</span>';
		}

		function togglePrintMode(mode) {
			const container = document.getElementById('qr-container');
			if (mode === 'qr-only') {
				container.classList.add('qr-only-mode');
			} else {
				container.classList.remove('qr-only-mode');
			}
		}

		function openPreviewTab() {
			currentPrintTarget = 'all';
			if (logoDataUrl) {
				document.getElementById('print-modal').classList.remove('hidden');
				document.getElementById('print-modal').classList.add('flex');
			} else {
				processPrint(false);
			}
		}
		
		// NEW: Open QR Preview Modal for single card
		let currentQrDataUrl = null; // Store QR dataURL for export
		
		function previewSingle(cardId) {
			currentPreviewCardId = cardId;
			
			const card = document.getElementById(cardId);
			if (!card) return;
			
			// Find QR source (canvas or img)
			const qrWrapper = card.querySelector('.qr-wrapper div[id^="qr-"]');
			const canvas = qrWrapper ? qrWrapper.querySelector('canvas') : null;
			const img = qrWrapper ? qrWrapper.querySelector('img') : null;
			const credentials = card.querySelector('.voucher-credentials');
			
			// Get modal elements
			const modal = document.getElementById('qr-preview-modal');
			const previewArea = document.getElementById('modal-qr-preview');
			const credentialsArea = document.getElementById('modal-credentials');
			const btnWithLogo = document.getElementById('btn-with-logo');
			
			// Generate preview image and store dataURL
			const previewSize = 256;
			previewArea.innerHTML = '';
			previewArea.style.width = previewSize + 'px';
			previewArea.style.height = previewSize + 'px';
			previewArea.style.position = 'relative';
			
			// Get QR dataURL from canvas or img
			if (canvas) {
				currentQrDataUrl = canvas.toDataURL('image/png');
			} else if (img && img.src) {
				currentQrDataUrl = img.src;
			} else {
				currentQrDataUrl = null;
			}
			
			if (currentQrDataUrl) {
				const qrImg = document.createElement('img');
				qrImg.src = currentQrDataUrl;
				qrImg.style.width = '100%';
				qrImg.style.height = '100%';
				previewArea.appendChild(qrImg);
				
				// Add logo overlay if exists
				if (logoDataUrl) {
					const logoOverlay = document.createElement('img');
					logoOverlay.src = logoDataUrl;
					logoOverlay.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-1 rounded';
					logoOverlay.style.width = '25%';
					logoOverlay.style.height = '25%';
					logoOverlay.style.objectFit = 'contain';
					previewArea.appendChild(logoOverlay);
				}
			}
			
			// Show/hide "With Logo" button based on logo presence
			if (logoDataUrl) {
				btnWithLogo.style.display = 'flex';
			} else {
				btnWithLogo.style.display = 'none';
			}
			
			// Copy credentials
			if (credentials) {
				credentialsArea.innerHTML = credentials.innerHTML;
			} else {
				credentialsArea.innerHTML = '';
			}
			
			// Show modal
			modal.classList.remove('hidden');
			modal.classList.add('flex');
		}
		
		function closeQrPreviewModal(event) {
			// If event exists and target is not the backdrop, don't close
			if (event && event.target !== document.getElementById('qr-preview-modal')) {
				return;
			}
			document.getElementById('qr-preview-modal').classList.add('hidden');
			document.getElementById('qr-preview-modal').classList.remove('flex');
		}
		
		// NEW: Open merged image in new tab
		function openMergedImage(includeLogo) {
			if (!currentQrDataUrl) {
				alert('QR image not available');
				return;
			}
			
			// Create a new canvas for merging
			const mergeCanvas = document.createElement('canvas');
			const ctx = mergeCanvas.getContext('2d');
			const size = 512; // HD export size
			mergeCanvas.width = size;
			mergeCanvas.height = size;
			
			// Load QR image
			const qrImage = new Image();
			qrImage.onload = function() {
				// Draw QR code
				ctx.drawImage(qrImage, 0, 0, size, size);
				
				if (includeLogo && logoDataUrl) {
					// Draw logo on top
					const logoImage = new Image();
					logoImage.onload = function() {
						const logoSize = size * 0.22; // Logo = ~22% of QR (slightly larger for padding)
						const logoX = (size - logoSize) / 2;
						const logoY = (size - logoSize) / 2;
						const borderRadius = 10; // Rounded corners radius
						
						// Draw Rounded White Background
						ctx.fillStyle = 'white';
						ctx.beginPath();
						if (ctx.roundRect) {
							ctx.roundRect(logoX - 4, logoY - 4, logoSize + 8, logoSize + 8, borderRadius);
						} else {
							ctx.rect(logoX - 4, logoY - 4, logoSize + 8, logoSize + 8); // Fallback
						}
						ctx.fill();
						
						// Draw Rounded Image using Clip
						ctx.save();
						ctx.beginPath();
						if (ctx.roundRect) {
							ctx.roundRect(logoX, logoY, logoSize, logoSize, borderRadius - 2);
						} else {
							ctx.rect(logoX, logoY, logoSize, logoSize);
						}
						ctx.clip();
						
						// Draw logo
						ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
						ctx.restore();
						
						openImageInWindow(mergeCanvas.toDataURL('image/png'));
					};
					logoImage.src = logoDataUrl;
				} else {
					openImageInWindow(mergeCanvas.toDataURL('image/png'));
				}
			};
			qrImage.src = currentQrDataUrl;
			
			closeQrPreviewModal();
		}

		function openImageInWindow(dataUrl) {
			const win = window.open('', '_blank');
			if (!win) {
				alert('Popup blocked! Please allow popups for this site.');
				return;
			}
			win.document.write(`
				<!DOCTYPE html>
				<html>
				<head>
					<title>QR Code Export</title>
					<style>
						body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #f3f4f6; }
						/* Removed border-radius from img to keep QR sharp */
						img { max-width: 90%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
						.btn { margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; text-decoration: none; border-radius: 5px; font-family: sans-serif; font-weight: bold; }
						.btn:hover { background: #1d4ed8; }
						p { font-family: sans-serif; color: #6b7280; margin-top: 10px; }
					</style>
				</head>
				<body>
					<img src="${dataUrl}" alt="QR Code">
					<p>Right-click image to Save As...</p>
					<a href="${dataUrl}" download="qrcode.png" class="btn">Download Image</a>
				</body>
				</html>
			`);
			win.document.close();
		}

		function closePrintModal() {
			document.getElementById('print-modal').classList.add('hidden');
			document.getElementById('print-modal').classList.remove('flex');
		}

		function processPrint(includeLogo) {
			closePrintModal();

			const qrContainer = document.getElementById('qr-container');
			const clone = qrContainer.cloneNode(true); // Clone everything first
			
			// FILTERING LOGIC: If Single Target, remove others from clone
			if (currentPrintTarget !== 'all') {
				const targetCard = clone.querySelector('#' + currentPrintTarget);
				clone.innerHTML = ''; // Wipe clone
				if (targetCard) {
					clone.appendChild(targetCard); // Add back ONLY target
				}
			}
			
			// Handle Logo Removal if requested
			if (!includeLogo) {
				clone.querySelectorAll('.qr-logo').forEach(el => el.remove());
			}

			// Serialize Canvases to Images (Logic updated for robust dimensions)
			// We need to map from ORIGINAL container to CLONE
			// because the clone's canvases are blank.
			
			// If we filtered to single card, we must map carefully.
			// Strategy: Iterate over original canvases. If their ID matches a card in the clone, process it.
			// But canvas IDs are inside card IDs.
			
			const originalCanvases = qrContainer.querySelectorAll('canvas');
			
			originalCanvases.forEach((canvas) => {
				// Find closest voucher-ID from original canvas
				const originalCard = canvas.closest('.voucher-card');
				if (!originalCard) return;
				const cardId = originalCard.id;
				
				// If we are in Single Mode and this isn't the target, skip
				if (currentPrintTarget !== 'all' && cardId !== currentPrintTarget) return;

				// Find this card in the clone
				const cloneCard = clone.querySelector('#' + cardId);
				if (cloneCard) {
					// Find the canvas inside this clone card
					// Note: qrcode.js puts canvas inside the div with id `qr-${voucherCount}`
					const cloneCanvasWrapper = cloneCard.querySelector('.qr-wrapper div[id^="qr-"]');
					const cloneCanvas = cloneCanvasWrapper ? cloneCanvasWrapper.querySelector('canvas') : null;
					
					if (cloneCanvas) {
						const img = document.createElement('img');
						img.src = canvas.toDataURL();
						img.style.cssText = canvas.style.cssText;
						img.className = canvas.className;
						img.width = canvas.width;
						img.height = canvas.height;
						img.style.width = '100%';
						img.style.height = 'auto'; // Fix Aspect Ratio (Keep 1:1)
						img.style.display = 'block';

						const parent = cloneCanvas.parentNode;
						parent.innerHTML = ''; 
						parent.appendChild(img);
						parent.style.width = '100%';
						parent.style.height = 'auto'; // Allow wrapper to shrink-fit the 1:1 image
						
						// Re-inject logo if needed (complex because we wiped parent innerHTML?)
						// No, the logo is OUTSIDE the qr-X div. It's in .qr-wrapper (sibling).
						// So wiping parent (qr-X) is safe.
					}
				}
			});

			const printContent = clone.innerHTML;
			const isQrOnly = qrContainer.classList.contains('qr-only-mode');
			const displaySize = document.getElementById('display-size').value; 
			let cols = 4;
			if (displaySize == '150') cols = 5;
			if (displaySize == '100') cols = 6;
			
			// Forced override for Single Card: Center it
			let gridCss = '';
			if (currentPrintTarget !== 'all') {
				gridCss = 'display: flex !important; justify-content: center !important;';
			} else {
				gridCss = `display: grid; gap: 16px; justify-content: center; grid-template-columns: repeat(${cols}, max-content);`;
			}
			
			let scaleCss = '';
			if (cols >= 6 && currentPrintTarget === 'all') {
				// Adjusted for cleaner A4 fit without breaking layout
				scaleCss = `
						/* SHARED STYLES (Screen & Print) */
						/* Compact Card for 6-Column Layout (Slim Fit) */
						.voucher-card {
							transform: scale(0.99); /* 99% Scale as requested */
							transform-origin: center top;
							margin: 0 !important;
							padding: 0 !important;
							border: 1px solid #ddd;
							page-break-inside: avoid;
							width: 100% !important; 
						}
						.voucher-card .card-body {
							padding: 6px !important; /* Comfortable side padding */
						}
						/* Ensure QR Image scales down to fit padding */
						.voucher-card .qr-wrapper {
							width: 100% !important;
							max-width: 100% !important;
						}
						.voucher-card .qr-wrapper > div {
							width: auto !important;
							max-width: 100% !important;
						}
						.voucher-card img, .voucher-card canvas {
							max-width: 100% !important;
							height: auto !important;
							display: block !important;
							margin: 0 auto !important;
						}
						/* Credentials Styling */
						.voucher-card .voucher-credentials p {
							white-space: nowrap; 
							overflow: hidden;
							text-overflow: ellipsis;
						}
						.voucher-card .text-xs {
							font-size: 0.5rem !important;
						}
						
						/* Screen Preview Only (Paper Simulation) */
						@media screen {
							body {
								background: #525659;
								display: flex;
								justify-content: center;
								padding: 20px;
								margin: 0;
							}
							#qr-container {
								background: white;
								width: 210mm;
								min-height: 297mm;
								padding: 10mm;
								box-sizing: border-box;
								margin-bottom: 20px;
								/* Grid Layout for Screen */
								display: grid;
								grid-template-columns: repeat(6, 1fr);
								gap: 6mm 4mm;
								justify-items: center;
								align-content: start;
							}
						}

						/* Print Rules */
						@page {
							size: A4 portrait;
							margin: 10mm; 
						}
						
						@media print {
							body {
								background: white;
								margin: 0 !important;
								padding: 0 !important;
								box-sizing: border-box !important;
								min-height: 100vh;
								display: block !important;
							}
							
							#qr-container { 
								width: 100% !important;
								min-height: auto !important;
								box-shadow: none !important;
								padding: 0 !important;
								margin: 0 auto !important;
								display: grid !important;
								grid-template-columns: repeat(6, 1fr) !important;
								gap: 6mm 4mm !important; 
								justify-items: center !important;
							}
						}
				`;
			} else if (cols === 5 && currentPrintTarget === 'all') {
				// MEDIUM (5 Columns) Optimization
				scaleCss = `
						/* SHARED STYLES (Screen & Print) */
						.voucher-card {
							transform: scale(0.95); /* 95% Scale for 5-col fit */
							transform-origin: center top;
							margin: 0 !important;
							padding: 0 !important;
							border: 1px solid #ddd;
							page-break-inside: avoid;
							width: 100% !important; 
						}
						.voucher-card .card-body {
							padding: 8px !important; /* Slightly more padding than small */
						}
						/* Strict Aspect Ratio & Scaling */
						.voucher-card .qr-wrapper {
							width: 100% !important;
							max-width: 100% !important;
							height: auto !important;
							aspect-ratio: 1/1 !important;
						}
						.voucher-card .qr-wrapper > div {
							width: auto !important;
							max-width: 100% !important;
						}
						.voucher-card img, .voucher-card canvas {
							max-width: 100% !important;
							height: auto !important;
							display: block !important;
							margin: 0 auto !important;
						}
						
						.voucher-card .voucher-credentials p {
							margin: 1px 0 !important;
							white-space: nowrap; 
							overflow: hidden;
							text-overflow: ellipsis; 
						}
						.voucher-card .text-xs {
							font-size: 0.6rem !important; 
						}
						
						@media screen {
							body {
								background: #525659;
								display: flex;
								justify-content: center;
								padding: 20px;
								margin: 0;
							}
							#qr-container {
								background: white;
								width: 210mm;
								min-height: 297mm;
								padding: 10mm;
								box-sizing: border-box;
								margin-bottom: 20px;
								display: grid;
								grid-template-columns: repeat(5, 1fr) !important;
								gap: 8mm 6mm !important; /* Larger gap for medium */
								justify-items: center;
								align-content: start;
							}
						}
						
						@media print {
							body {
								background: white;
								margin: 0 !important;
								padding: 0 !important;
								box-sizing: border-box !important;
								min-height: 100vh;
								display: block !important;
							}
							#qr-container {
								width: 100% !important;
								min-height: auto !important;
								box-shadow: none !important;
								padding: 0 !important;
								margin: 0 auto !important;
								display: grid !important;
								grid-template-columns: repeat(5, 1fr) !important;
								gap: 8mm 6mm !important;
								justify-items: center !important;
							}
						}
				`;
			} else if (cols === 4 && currentPrintTarget === 'all') {
				// LARGE (4 Columns) Optimization
				scaleCss = `
						/* SHARED STYLES (Screen & Print) */
						.voucher-card {
							transform: scale(0.90); /* 90% Scale for 4-col fit */
							transform-origin: center top;
							margin: 0 !important;
							padding: 0 !important;
							border: 1px solid #ddd;
							page-break-inside: avoid;
							width: 100% !important; 
						}
						.voucher-card .card-body {
							padding: 10px !important; /* Generous padding for large */
						}
						/* Strict Aspect Ratio & Scaling */
						.voucher-card .qr-wrapper {
							width: 100% !important;
							max-width: 100% !important;
							height: auto !important;
							aspect-ratio: 1/1 !important;
							line-height: 0 !important; /* Kill baseline gap */
						}
						/* Redundant cleanup for safety */
						.voucher-card .qr-wrapper > div {
							width: auto !important;
							max-width: 100% !important;
						}
						.voucher-card img, .voucher-card canvas {
							max-width: 100% !important;
							height: auto !important;
							display: block !important;
							margin: 0 auto !important;
						}
						
						.voucher-card .voucher-credentials p {
							margin: 2px 0 !important;
							white-space: nowrap; 
							overflow: hidden;
							text-overflow: ellipsis; 
						}
						.voucher-card .text-xs {
							font-size: 0.7rem !important; 
						}
						
						@media screen {
							body {
								background: #525659;
								display: flex;
								justify-content: center;
								padding: 20px;
								margin: 0;
							}
							#qr-container {
								background: white;
								width: 210mm;
								min-height: 297mm;
								padding: 10mm;
								box-sizing: border-box;
								margin-bottom: 20px;
								display: grid;
								grid-template-columns: repeat(4, 1fr) !important;
								gap: 10mm 8mm !important; /* Wide gap for large */
								justify-items: center;
								align-content: start;
							}
						}
						
						@media print {
							body {
								background: white;
								margin: 0 !important;
								padding: 0 !important;
								box-sizing: border-box !important;
								min-height: 100vh;
								display: block !important;
							}
							#qr-container {
								width: 100% !important;
								min-height: auto !important;
								box-shadow: none !important;
								padding: 0 !important;
								margin: 0 auto !important;
								display: grid !important;
								grid-template-columns: repeat(4, 1fr) !important;
								gap: 10mm 8mm !important;
								justify-items: center !important;
							}
						}
				`;
			}
			
			const styles = Array.from(document.styleSheets)
				.map(styleSheet => {
					try { return Array.from(styleSheet.cssRules).map(rule => rule.cssText).join(''); } catch (e) { return ''; }
				})
				.join('');

			const win = window.open('', '_blank');
			
			win.document.write(`
				<!DOCTYPE html>
				<html>
				<head>
					<title>Print Preview - QR Vouchers</title>
					<script src="https://cdn.tailwindcss.com"><\/script>
					<style>
						${styles}
						.qr-wrapper { position: relative !important; display: inline-block !important; }
						.qr-logo { position: absolute !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; background: white !important; padding: 2px !important; border-radius: 4px !important; z-index: 10 !important; }
						body { background: white; padding: 20px; }
						.no-print { display: none !important; }
						.voucher-card { page-break-inside: avoid; break-inside: avoid; margin: 0 auto; }
						
						#qr-container { ${currentPrintTarget === 'all' ? `grid-template-columns: repeat(${cols}, auto) !important;` : ''} }
						#qr-container.grid-auto { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)) !important; }
						
						.voucher-card { box-shadow: none !important; border: 1px solid #ccc !important; padding-top: 0 !important; padding-bottom: 0 !important; }
						.card-body { padding: 0.75rem !important; }
						.text-xs { font-size: 0.6rem !important; }
						
						${isQrOnly ? `.voucher-credentials { display: none !important; } .separator-line { display: none !important; } .card-header { display: none !important; } .qr-wrapper { margin-bottom: 0 !important; line-height: 0 !important; height: auto !important; aspect-ratio: 1/1 !important; } .card-body { padding: 0 !important; line-height: 0 !important; } .voucher-card { width: auto !important; max-width: 100% !important; padding: 10px !important; border: 1px solid #ccc !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; }` : ''}
						
						@media print { body { padding: 0; } #qr-container { width: 100%; justify-content: center; gap: 4mm !important; ${currentPrintTarget !== 'all' ? 'display: flex !important;' : 'display: grid !important;'} } }
						${scaleCss}
					</style>
				</head>
				<body>
					<div class="no-print bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 flex justify-between items-center">
						<p><b>Preview Mode:</b> A4 Portrait optimized. Press <b>Ctrl+P</b> to print. ${includeLogo ? '(With Logo)' : '(No Logo)'}</p>
						<button onclick="window.close()" class="bg-red-500 text-white px-3 py-1 rounded font-bold">Close</button>
					</div>
					<div id="qr-container" class="${isQrOnly ? 'qr-only-mode' : ''}" style="${gridCss}">
						${printContent}
					</div>
					<script>document.querySelectorAll('#qr-container button').forEach(btn => btn.remove());<\/script>
				</body>
				</html>
			`);
			win.document.close();
		}

		function switchTab(tab) {
			const singleTab = document.getElementById('tab-single');
			const bulkTab = document.getElementById('tab-bulk');
			const singleInput = document.getElementById('input-single');
			const bulkInput = document.getElementById('input-bulk');

			if (tab === 'single') {
				singleTab.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600';
				bulkTab.className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
				singleInput.classList.remove('hidden');
				bulkInput.classList.add('hidden');
			} else {
				bulkTab.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600';
				singleTab.className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
				bulkInput.classList.remove('hidden');
				singleInput.classList.add('hidden');
			}
		}

		function updateDisplaySize() {
			const size = parseInt(document.getElementById('display-size').value);
			const logoSizePercent = parseInt(document.getElementById('logo-size').value);
			const logoSize = Math.round(size * logoSizePercent / 100);
			
			const qrWrappers = document.querySelectorAll('.qr-wrapper');
			qrWrappers.forEach(wrapper => {
				wrapper.style.width = size + 'px';
				wrapper.style.height = size + 'px';
				
				// Scale QR image/canvas
				const qrContainer = wrapper.querySelector('div[id^="qr-"]');
				if (qrContainer) {
					const qrImg = qrContainer.querySelector('img');
					const qrCanvas = qrContainer.querySelector('canvas');
					if (qrImg) {
						qrImg.style.width = '100%';
						qrImg.style.height = '100%';
					}
					if (qrCanvas) {
						qrCanvas.style.width = '100%';
						qrCanvas.style.height = '100%';
					}
				}
				
				// Scale logo
				const logo = wrapper.querySelector('.qr-logo');
				if (logo) {
					logo.style.width = logoSize + 'px';
					logo.style.height = logoSize + 'px';
				}
			});
		}

		function toggleSingleMode() {
			const isSame = document.querySelector('input[name="single-mode"][value="same"]').checked;
			const passWrapper = document.getElementById('single-password-wrapper');
			if (isSame) {
				passWrapper.classList.add('hidden');
			} else {
				passWrapper.classList.remove('hidden');
			}
		}

		function toggleBulkMode() {
			const isSame = document.querySelector('input[name="bulk-mode"][value="same"]').checked;
			const input = document.getElementById('bulk-input');
			const hint = document.getElementById('bulk-hint');
			
			if (isSame) {
				input.placeholder = "user1\nuser2\nuser3";
				hint.textContent = "Format: username (one per line). Password will equal Username.";
			} else {
				input.placeholder = "user1:pass1\nuser2:pass2\nuser3:pass3";
				hint.textContent = "Format: username:password (one per line)";
			}
		}

		function generateSingle() {
			const username = document.getElementById('single-username').value.trim();
			
			// Detect mode
			const modeInput = document.querySelector('input[name="single-mode"][value="same"]');
			const isSame = modeInput && modeInput.checked;
			
			let password = '';
			if (isSame) {
				password = username;
			} else {
				password = document.getElementById('single-password').value.trim();
			}

			if (!username) {
				alert('Please enter username');
				return;
			}
			if (!isSame && !password) {
				alert('Please enter password');
				return;
			}

			createVoucherCard(username, password);
			document.getElementById('actions-section').style.display = 'flex';
			
			// Clear inputs
			document.getElementById('single-username').value = '';
			document.getElementById('single-password').value = '';
		}

		function generateBulk() {
			const bulkText = document.getElementById('bulk-input').value.trim();
			
			// Detect mode
			const modeInput = document.querySelector('input[name="bulk-mode"][value="same"]');
			const isSame = modeInput && modeInput.checked;
			
			if (!bulkText) {
				alert('Please enter voucher list');
				return;
			}

			const lines = bulkText.split('\n');
			let generated = 0;

			for (const line of lines) {
				const trimmed = line.trim();
				if (!trimmed) continue;

				let username = '';
				let password = '';

				if (isSame) {
					username = trimmed;
					password = trimmed;
				} else {
					const colonIndex = trimmed.indexOf(':');
					if (colonIndex > 0 && colonIndex < trimmed.length - 1) {
						username = trimmed.substring(0, colonIndex);
						password = trimmed.substring(colonIndex + 1);
					} else {
						// Skip invalid lines in user:pass mode
						continue;
					}
				}

				createVoucherCard(username, password);
				generated++;
			}

			if (generated > 0) {
				document.getElementById('actions-section').style.display = 'flex';
				showToast(`Generated ${generated} QR codes`);
			} else {
				showToast(isSame ? 'No valid usernames found.' : 'No valid vouchers found. Use format: username:password');
			}
		}

		function createVoucherCard(username, password) {
			voucherCount++;
			const qrContent = `${username}:${password}`;
			const container = document.getElementById('qr-container');
			const logoSizePercent = parseInt(document.getElementById('logo-size').value);
			const displaySize = parseInt(document.getElementById('display-size').value);
			const logoSize = Math.round(displaySize * logoSizePercent / 100);

			// Create card
			const card = document.createElement('div');
			card.className = 'voucher-card bg-white rounded-lg shadow-md overflow-hidden w-fit';
			card.id = `voucher-${voucherCount}`;

			// Logo HTML
			const logoHtml = logoDataUrl 
				? `<img src="${logoDataUrl}" class="qr-logo" style="width:${logoSize}px; height:${logoSize}px; object-fit:contain;">`
				: '';

			// Credential HTML logic
			// Credential HTML logic
			let credentialHtml = '';
			if (username === password) {
				credentialHtml = `
					<div class="voucher-credentials">
						<p class="text-xs text-gray-500 mb-0">Username = Password</p>
						<p class="font-bold text-gray-800 text-base leading-tight mt-0">${escapeHtml(username)}</p>
					</div>
				`;
			} else {
				credentialHtml = `
					<div class="voucher-credentials">
						<div class="mb-1">
							<p class="text-xs text-gray-500 mb-0">Username</p>
							<p class="font-bold text-gray-800 leading-tight mt-0">${escapeHtml(username)}</p>
						</div>
						<div>
							<p class="text-xs text-gray-500 mb-0">Password</p>
							<p class="font-bold text-gray-800 leading-tight mt-0">${escapeHtml(password)}</p>
						</div>
					</div>
				`;
			}

			// Card content with header/body structure
			card.innerHTML = `
				<div class="card-header flex justify-end p-2 gap-2 no-print">
					<button onclick="previewSingle('voucher-${voucherCount}')" class="text-gray-400 hover:text-blue-500 transition-colors" title="Print/Preview Single">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
						</svg>
					</button>
					<button onclick="removeCard('voucher-${voucherCount}')" class="text-gray-400 hover:text-red-500 transition-colors" title="Remove">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
						</svg>
					</button>
				</div>
				<div class="card-body px-3 pb-3 text-center">
					<div class="qr-wrapper">
						<div id="qr-${voucherCount}" class="flex justify-center"></div>
						${logoHtml}
					</div>
					<div class="separator-line border-t border-gray-300 my-2 w-full"></div>
					${credentialHtml}
				</div>
			`;

			container.appendChild(card);

			// Generate QR code at HD resolution (512px) for print quality
			new QRCode(document.getElementById(`qr-${voucherCount}`), {
				text: qrContent,
				width: 512,
				height: 512,
				colorDark: '#000000',
				colorLight: '#ffffff',
				correctLevel: QRCode.CorrectLevel.H  // High error correction for logo overlay
			});

			// Apply display size via CSS
			const wrapper = card.querySelector('.qr-wrapper');
			if (wrapper) {
				wrapper.style.width = displaySize + 'px';
				wrapper.style.height = displaySize + 'px';
				// Wait for QR to render then scale
				setTimeout(() => {
					const img = wrapper.querySelector('img');
					const canvas = wrapper.querySelector('canvas');
					if (img) {
						img.style.width = '100%';
						img.style.height = '100%';
					}
					if (canvas) {
						canvas.style.width = '100%';
						canvas.style.height = '100%';
					}
				}, 100);
			}
		}

		function removeCard(cardId) {
			const card = document.getElementById(cardId);
			if (card) {
				card.remove();
			}

			// Hide actions if no cards left
			if (document.getElementById('qr-container').children.length === 0) {
				document.getElementById('actions-section').style.display = 'none';
			}
		}

		function clearAll() {
			if (confirm('Clear all generated QR codes?')) {
				document.getElementById('qr-container').innerHTML = '';
				document.getElementById('actions-section').style.display = 'none';
				voucherCount = 0;
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
	<!-- Toast User Notification -->
	<div id="toast-notification"></div>
	
	<script>
		// Toast Functionality
		function showToast(message, duration = 3000) {
			const toast = document.getElementById("toast-notification");
			toast.textContent = message;
			toast.className = "show";
			setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, duration);
		}
	</script>
</body>
</html>
